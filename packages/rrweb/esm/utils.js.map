{"version":3,"file":"utils.js","sourceRoot":"","sources":["../src/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Mirror,\n  throttleOptions,\n  listenerHandler,\n  hookResetter,\n  blockClass,\n} from './types';\nimport { INode } from '@partial/rrweb-snapshot';\n\nexport function on(\n  type: string,\n  fn: EventListenerOrEventListenerObject,\n  target: Document | Window = document,\n): listenerHandler {\n  const options = { capture: true, passive: true };\n  target.addEventListener(type, fn, options);\n  return () => target.removeEventListener(type, fn, options);\n}\n\nexport const mirror: Mirror = {\n  map: {},\n  getId(n) {\n    // if n is not a serialized INode, use -1 as its id.\n    if (!n.__sn) {\n      return -1;\n    }\n    return n.__sn.id;\n  },\n  getNode(id) {\n    return mirror.map[id] || null;\n  },\n  // TODO: use a weakmap to get rid of manually memory management\n  removeNodeFromMap(n) {\n    const id = n.__sn && n.__sn.id;\n    delete mirror.map[id];\n    if (n.childNodes) {\n      n.childNodes.forEach(child =>\n        mirror.removeNodeFromMap((child as Node) as INode),\n      );\n    }\n  },\n  has(id) {\n    return mirror.map.hasOwnProperty(id);\n  },\n};\n\n// copy from underscore and modified\nexport function throttle<T>(\n  func: (arg: T) => void,\n  wait: number,\n  options: throttleOptions = {},\n) {\n  let timeout: number | null = null;\n  let previous = 0;\n  // tslint:disable-next-line: only-arrow-functions\n  return function() {\n    let now = Date.now();\n    if (!previous && options.leading === false) {\n      previous = now;\n    }\n    let remaining = wait - (now - previous);\n    let context = this;\n    let args = arguments;\n    if (remaining <= 0 || remaining > wait) {\n      if (timeout) {\n        window.clearTimeout(timeout);\n        timeout = null;\n      }\n      previous = now;\n      func.apply(context, args);\n    } else if (!timeout && options.trailing !== false) {\n      timeout = window.setTimeout(() => {\n        previous = options.leading === false ? 0 : Date.now();\n        timeout = null;\n        func.apply(context, args);\n      }, remaining);\n    }\n  };\n}\n\nexport function hookSetter<T>(\n  target: T,\n  key: string | number | symbol,\n  d: PropertyDescriptor,\n): hookResetter {\n  const original = Object.getOwnPropertyDescriptor(target, key);\n  Object.defineProperty(target, key, {\n    set(value) {\n      // put hooked setter into event loop to avoid of set latency\n      setTimeout(() => {\n        d.set!.call(this, value);\n      }, 0);\n      if (original && original.set) {\n        original.set.call(this, value);\n      }\n    },\n  });\n  return () => hookSetter(target, key, original || {});\n}\n\nexport function getWindowHeight(): number {\n  return (\n    window.innerHeight ||\n    (document.documentElement && document.documentElement.clientHeight) ||\n    (document.body && document.body.clientHeight)\n  );\n}\n\nexport function getWindowWidth(): number {\n  return (\n    window.innerWidth ||\n    (document.documentElement && document.documentElement.clientWidth) ||\n    (document.body && document.body.clientWidth)\n  );\n}\n\nexport function isBlocked(node: Node | null, blockClass: blockClass): boolean {\n  if (!node) {\n    return false;\n  }\n  if (node.nodeType === node.ELEMENT_NODE) {\n    let needBlock = false;\n    if (typeof blockClass === 'string') {\n      needBlock = (node as HTMLElement).classList.contains(blockClass);\n    } else {\n      (node as HTMLElement).classList.forEach(className => {\n        if (blockClass.test(className)) {\n          needBlock = true;\n        }\n      });\n    }\n    return needBlock || isBlocked(node.parentNode, blockClass);\n  }\n  return isBlocked(node.parentNode, blockClass);\n}\n\nexport function isAncestorRemoved(target: INode): boolean {\n  const id = mirror.getId(target);\n  if (!mirror.has(id)) {\n    return true;\n  }\n  if (\n    target.parentNode &&\n    target.parentNode.nodeType === target.DOCUMENT_NODE\n  ) {\n    return false;\n  }\n  // if the root is not document, it means the node is not in the DOM tree anymore\n  if (!target.parentNode) {\n    return true;\n  }\n  return isAncestorRemoved((target.parentNode as unknown) as INode);\n}\n"]}